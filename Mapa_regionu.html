<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <title>Mapa Podziału DTH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <!-- Ikony (opcjonalnie, na przyszłość) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-muted: #6b7280;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 360px;
            max-width: 100%;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: #f9fafb;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .controls {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .btn-toggle {
            width: 100%;
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.18s ease;
        }

        .btn-toggle span.badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #f3f4f6;
            color: var(--text-muted);
        }

        .btn-toggle.active {
            border-color: var(--primary);
            background: var(--primary-soft);
        }

        .btn-toggle.active span.badge {
            background: var(--primary);
            color: #fff;
        }

        .map-type-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 6px;
        }

        .map-btn {
            padding: 5px 6px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-muted);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.18s ease;
        }

        .map-btn:hover {
            background: #f9fafb;
        }

        .map-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .search-box {
            margin: 8px 0 10px;
        }

        .search-input {
            width: 100%;
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 12px;
            outline: none;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.1);
        }

        .list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 14px 16px;
        }

        .region-item {
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 8px 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .region-item:hover {
            background: #f3f4f6;
            border-color: var(--primary-soft);
        }

        .region-item.active {
            background: var(--primary-soft);
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12);
        }

        .region-id {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .region-meta-line {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .map-wrapper {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .leaflet-popup-content {
            margin: 6px 10px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 999px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        @media (max-width: 900px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 50vh;
                max-height: 50vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .map-wrapper {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <aside class="sidebar">
        <header class="sidebar-header">
            <div class="sidebar-title">Mapa regionów</div>
            <div class="sidebar-subtitle">
                Kliknij region, aby przybliżyć.
            </div>
        </header>

        <section class="controls">
            <div class="control-group">
                <label class="control-label">Kolorowanie regionów</label>
                <button class="btn-toggle active" id="colorToggle" onclick="toggleColors()">
                    <span>Kolory terytoriów</span>
                    <span class="badge" id="colorText">Włączone</span>
                </button>
            </div>

            <div class="control-group">
                <label class="control-label">Typ podkładu mapy</label>
                <div class="map-type-grid">
                    <button class="map-btn" onclick="changeMap('osm', this)">OSM</button>
                    <button class="map-btn active" onclick="changeMap('positron', this)">Positron</button>
                    <button class="map-btn" onclick="changeMap('voyager', this)">Voyager</button>
                    <button class="map-btn" onclick="changeMap('topo', this)">Topo</button>
                    <button class="map-btn" onclick="changeMap('satellite', this)">Satelita</button>
                    <button class="map-btn" onclick="changeMap('dark', this)">Dark</button>
                    <button class="map-btn" onclick="changeMap('esri', this)">Esri</button>
                    <button class="map-btn" onclick="changeMap('humanitarian', this)">HOT</button>
                    <button class="map-btn" onclick="changeMap('stamen', this)">OSM DE</button>
                </div>
            </div>

            <!-- WYSZUKIWANIE REGIONÓW (ID / DTH / MI) -->
            <div class="control-group search-box">
                <label class="control-label">Wyszukiwanie regionów</label>
                <input
                    type="text"
                    id="regionSearch"
                    class="search-input"
                    placeholder="Szukaj regionu (ID / DTH / MI)..."
                    oninput="filterRegionList(this.value)"
                />
            </div>

            <!-- WYSZUKIWANIE MIAST NA MAPIE -->
            <div class="control-group search-box">
                <label class="control-label">Wyszukiwanie miasta</label>
                <input
                    type="text"
                    id="searchInput"
                    class="search-input"
                    placeholder="Wpisz nazwę miasta i naciśnij Enter..."
                    onkeydown="if (event.key === 'Enter') searchCity(this.value)"
                />
            </div>
        </section>

        <div class="list" id="listContainer"></div>
    </aside>

    <main class="map-wrapper">
        <div id="map"></div>
    </main>
</div>

<script>
    const map = L.map('map', {
        center: [51.9, 19.1],
        zoom: 6,
        zoomControl: false
    });

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    let currentTile = 'positron';
    let colorEnabled = true;
    let tileLayer = null;
    let geoJsonLayer = null;
    let maskLayer = null;
    let geojsonData = null;

    const regionsMap = {};
    const allRegions = [];
    const featureMap = {};

    // Warstwy dla własnych danych (miasta / drogi)
    const customCitiesLayer = L.layerGroup().addTo(map);
    const customRoadsLayer = L.layerGroup().addTo(map);

    const tileProviders = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ''
        }),
        positron: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ''
        }),
        voyager: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: ''
        }),
        topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: ''
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18,
            attribution: ''
        }),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ''
        }),
        esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18,
            attribution: ''
        }),
        humanitarian: L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ''
        }),
        stamen: L.tileLayer('https://tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: ''
        })
    };

    // Domyślnie "czysta" mapa Positron (mniej napisów)
    tileProviders.positron.addTo(map);
    tileLayer = tileProviders.positron;

    // Ładowanie danych – map.geojson + granice państw (maska na świat)
    Promise.all([
        fetch('https://raw.githubusercontent.com/goliaaat/TT/main/map.geojson').then(r => r.json()),
        fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson').then(r => r.json())
    ])
        .then(([dthData, countriesData]) => {
            geojsonData = dthData;

            const poland = countriesData.features.find(f => f.properties.ADMIN === 'Poland');

            if (poland) {
                maskLayer = L.geoJSON({
                    type: 'FeatureCollection',
                    features: countriesData.features.filter(f => f.properties.ADMIN !== 'Poland')
                }, {
                    style: {
                        fillColor: '#ffffff',
                        fillOpacity: 1,
                        stroke: false
                    },
                    interactive: false
                }).addTo(map);
            }

            initMap();
            initCustomExamples();
        })
        .catch(e => console.error('Błąd ładowania danych:', e));

    function initMap() {
        geojsonData.features.forEach(f => {
            const props = f.properties;
            const regionId = props['ID REGION'];

            if (!regionsMap[regionId]) {
                regionsMap[regionId] = {
                    id: regionId,
                    dth: props.DTH || '-',
                    mi: props.MI || '-',
                    rks: props.RKS || '-',
                    ds: props.DS || '-',
                    kolor: props.fill || '#FF6B6B'
                };
                allRegions.push(regionsMap[regionId]);
            }
        });

        allRegions.sort((a, b) => parseFloat(a.id) - parseFloat(b.id));

        renderMapLayer();
        renderRegionList(allRegions);

        if (geoJsonLayer) {
            const bounds = geoJsonLayer.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [30, 30] });
            }
        }
    }

    function baseStyle(feature) {
        return {
            fillColor: colorEnabled ? (feature.properties.fill || '#FF6B6B') : '#e5e7eb',
            weight: 1.5,
            opacity: 0.9,
            color: '#4b5563',
            fillOpacity: colorEnabled ? 0.45 : 0.2
        };
    }

    function renderMapLayer() {
        if (geoJsonLayer) {
            map.removeLayer(geoJsonLayer);
            geoJsonLayer = null;
        }

        geoJsonLayer = L.geoJSON(geojsonData, {
            style: baseStyle,
            onEachFeature: (feature, layer) => {
                const props = feature.properties;
                const regionId = props['ID REGION'];

                if (!featureMap[regionId]) {
                    featureMap[regionId] = [];
                }
                featureMap[regionId].push(layer);

                const popupHtml = `
                    <div style="font-size:12px; max-width:220px;">
                        <div style="font-size:13px; font-weight:600; margin-bottom:4px; color:#111827;">
                            ID regionu: ${regionId}
                        </div>
                        <div style="margin-bottom:2px;"><strong>DTH:</strong> ${props.DTH || '-'}</div>
                        <div style="margin-bottom:2px;"><strong>MI:</strong> ${props.MI || '-'}</div>
                        <div style="margin-bottom:2px;"><strong>RKS:</strong> ${props.RKS || '-'}</div>
                        <div style="margin-bottom:2px;"><strong>DS:</strong> ${props.DS || '-'}</div>
                    </div>
                `;
                layer.bindPopup(popupHtml);

                layer.on('click', () => selectRegion(regionId));
                layer.on('mouseover', () => highlightRegion(regionId));
                layer.on('mouseout', () => resetHighlight(regionId));
            }
        }).addTo(map);
    }

    function renderRegionList(regions) {
        const container = document.getElementById('listContainer');
        container.innerHTML = '';

        regions.forEach(region => {
            const div = document.createElement('div');
            div.className = 'region-item';
            div.id = 'item-' + region.id;

            div.onclick = () => selectRegion(region.id);
            div.onmouseenter = () => highlightRegion(region.id);
            div.onmouseleave = () => resetHighlight(region.id);

            const formattedId = region.id.replace('.', ',');

            div.innerHTML = `
                <div class="region-id">ID: ${formattedId}</div>
                <div class="region-meta-line"><strong>DTH:</strong> ${region.dth || 'Brak danych'}</div>
                <div class="region-meta-line"><strong>MI:</strong> ${region.mi || '-'}</div>
            `;
            container.appendChild(div);
        });
    }

    function toggleColors() {
        colorEnabled = !colorEnabled;

        const btn = document.getElementById('colorToggle');
        const text = document.getElementById('colorText');

        if (colorEnabled) {
            btn.classList.add('active');
            text.textContent = 'Włączone';
        } else {
            btn.classList.remove('active');
            text.textContent = 'Wyłączone';
        }

        renderMapLayer();
    }

    function changeMap(type, buttonElement) {
        if (!tileProviders[type]) return;
        currentTile = type;

        if (tileLayer) {
            map.removeLayer(tileLayer);
        }
        tileLayer = tileProviders[type];
        tileLayer.addTo(map);

        document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
        if (buttonElement) {
            buttonElement.classList.add('active');
        }
    }

    function selectRegion(regionId) {
        document.querySelectorAll('.region-item').forEach(el => el.classList.remove('active'));
        const activeEl = document.getElementById('item-' + regionId);
        if (activeEl) {
            activeEl.classList.add('active');
            activeEl.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }

        if (featureMap[regionId] && featureMap[regionId].length > 0) {
            const group = new L.FeatureGroup(featureMap[regionId]);
            const bounds = group.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds, {
                    padding: [40, 40],
                    maxZoom: 10
                });
            }
        }
    }

    function highlightRegion(regionId) {
        if (!geoJsonLayer || !featureMap[regionId]) return;

        featureMap[regionId].forEach(layer => {
            layer.setStyle({
                weight: 3,
                color: '#111827',
                fillOpacity: colorEnabled ? 0.6 : 0.3
            });
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
        });
    }

    function resetHighlight(regionId) {
        if (!geoJsonLayer || !featureMap[regionId]) return;

        featureMap[regionId].forEach(layer => {
            geoJsonLayer.resetStyle(layer);
        });
    }

    let currentMarker = null;

    // Wyszukiwanie miasta po Enter
    function searchCity(query) {
        if (!query || query.trim().length < 2) return;

        const searchUrl =
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=pl&limit=5`;

        fetch(searchUrl)
            .then(r => r.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);

                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }

                    currentMarker = L.marker([lat, lon], {
                        icon: L.icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                            iconSize: [25, 41],
                            shadowSize: [41, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        })
                    }).addTo(map);

                    currentMarker.bindPopup(`<b>${result.display_name}</b>`).openPopup();
                    map.setView([lat, lon], 10);
                }
            })
            .catch(err => console.error('Błąd wyszukiwania miasta:', err));
    }

    // Filtrowanie listy regionów po ID / DTH / MI
    function filterRegionList(term) {
        const t = term.trim().toLowerCase();
        if (!t) {
            renderRegionList(allRegions);
            return;
        }

        const filtered = allRegions.filter(r =>
            (r.id || '').toLowerCase().includes(t) ||
            (r.dth || '').toLowerCase().includes(t) ||
            (r.mi || '').toLowerCase().includes(t) ||
            (r.rks || '').toLowerCase().includes(t) ||
            (r.ds || '').toLowerCase().includes(t)
        );

        renderRegionList(filtered);
    }

</script>
</body>
</html>

