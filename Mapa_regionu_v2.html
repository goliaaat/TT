<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <title>Mapa Podziału DTH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --border: #e5e7eb;
            --bg: #f3f4f6;
            --text-main: #111827;
            --text-muted: #6b7280;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text-main);
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 360px;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: #f9fafb;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .controls {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .btn-toggle {
            width: 100%;
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .btn-toggle.active {
            border-color: var(--primary);
            background: var(--primary-soft);
        }

        .map-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .map-btn {
            padding: 5px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 11px;
            cursor: pointer;
        }

        .map-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .search-input {
            width: 100%;
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 12px;
        }

        .list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 14px;
        }

        .region-item {
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 8px;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .region-item.active {
            background: var(--primary-soft);
            border-color: var(--primary);
        }

        .region-id {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .region-meta-line {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .map-wrapper {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-attribution {
            position: absolute;
            bottom: 6px;
            left: 8px;
            z-index: 500;
            font-size: 10px;
            color: #6b7280;
            background: rgba(255,255,255,0.85);
            padding: 3px 6px;
            border-radius: 6px;
        }

        .map-attribution a {
            color: #374151;
            text-decoration: none;
        }

        .map-attribution a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <header class="sidebar-header">
            <div class="sidebar-title">Mapa regionów</div>
            <div class="sidebar-subtitle">Kliknij region, aby przybliżyć</div>
        </header>

        <section class="controls">
            <div class="control-group">
                <label class="control-label">Kolory</label>
                <button class="btn-toggle active" id="colorToggle" onclick="toggleColors()">
                    <span>Kolory regionów</span>
                    <span id="colorText">Włączone</span>
                </button>
            </div>

            <div class="control-group">
                <label class="control-label">Podkład mapy</label>
                <div class="map-type-grid">
                    <button class="map-btn active" onclick="changeMap('positron', this)">Positron</button>
                    <button class="map-btn" onclick="changeMap('osm', this)">OSM</button>
                    <button class="map-btn" onclick="changeMap('satellite', this)">Satelita</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Szukaj regionu</label>
                <input class="search-input" id="regionSearch" oninput="filterRegionList(this.value)" placeholder="ID / DTH / MI / RKS / DS...">
            </div>

            <div class="control-group">
                <label class="control-label">Szukaj miasta</label>
                <input class="search-input" id="citySearch" onkeydown="if(event.key==='Enter') searchCity(this.value)" placeholder="Wpisz nazwę miasta...">
            </div>
        </section>

        <div class="list" id="listContainer"></div>
    </aside>

    <main class="map-wrapper">
        <div id="map"></div>
        <div class="map-attribution" id="mapAttribution">
            © <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors © CARTO
        </div>
    </main>
</div>

<script>
    const map = L.map('map', { 
        center: [52, 19], 
        zoom: 6,
        zoomControl: true
    });

    let tileLayer;
    let geoJsonLayer;
    let featureMap = {};
    let geojsonData;
    let colorEnabled = true;
    let currentMarker = null;

    const regionsMap = {};
    const allRegions = [];

    const tileProviders = {
        positron: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            maxZoom: 19
        }),
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }),
        satellite: L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18
        })
    };

    const attributionTexts = {
        positron: '© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors © CARTO',
        osm: '© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors',
        satellite: '© Esri'
    };

    function updateAttribution(type) {
        document.getElementById('mapAttribution').innerHTML = attributionTexts[type];
    }

    tileLayer = tileProviders.positron.addTo(map);

    // Ładowanie danych
    fetch('https://raw.githubusercontent.com/goliaaat/TT/main/map.geojson')
        .then(r => r.json())
        .then(data => {
            geojsonData = data;
            initMap();
        })
        .catch(e => console.error('Błąd ładowania danych:', e));

    function initMap() {
        // Budowanie listy regionów
        geojsonData.features.forEach(f => {
            const props = f.properties;
            const regionId = props['ID REGION'];

            if (!regionsMap[regionId]) {
                regionsMap[regionId] = {
                    id: regionId,
                    dth: props.DTH || '-',
                    mi: props.MI || '-',
                    rks: props.RKS || '-',
                    ds: props.DS || '-',
                    kolor: props.fill || '#FF6B6B'
                };
                allRegions.push(regionsMap[regionId]);
            }
        });

        allRegions.sort((a, b) => parseFloat(a.id) - parseFloat(b.id));

        renderMap();
        renderRegionList(allRegions);

        if (geoJsonLayer) {
            const bounds = geoJsonLayer.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [30, 30] });
            }
        }
    }

    function renderMap() {
        featureMap = {};

        if (geoJsonLayer) {
            map.removeLayer(geoJsonLayer);
        }

        geoJsonLayer = L.geoJSON(geojsonData, {
            style: f => ({
                fillColor: colorEnabled ? (f.properties.fill || '#ff6b6b') : '#e5e7eb',
                color: '#4b5563',
                weight: 1.5,
                fillOpacity: colorEnabled ? 0.45 : 0.2,
                opacity: 0.9
            }),
            onEachFeature: (f, layer) => {
                const props = f.properties;
                const regionId = props['ID REGION'];
                
                if (!featureMap[regionId]) {
                    featureMap[regionId] = [];
                }
                featureMap[regionId].push(layer);

                const popupHtml = `
                    <div style="font-size:12px; max-width:220px;">
                        <div style="font-size:13px; font-weight:600; margin-bottom:4px; color:#111827;">
                            ID: ${regionId}
                        </div>
                        <div style="margin-bottom:2px;"><strong>DTH:</strong> ${props.DTH || '-'}</div>
                        <div style="margin-bottom:2px;"><strong>MI:</strong> ${props.MI || '-'}</div>
                        <div style="margin-bottom:2px;"><strong>RKS:</strong> ${props.RKS || '-'}</div>
                        <div style="margin-bottom:2px;"><strong>DS:</strong> ${props.DS || '-'}</div>
                    </div>
                `;
                layer.bindPopup(popupHtml);

                layer.on('click', () => selectRegion(regionId));
                layer.on('mouseover', () => highlightRegion(regionId));
                layer.on('mouseout', () => resetHighlight(regionId));
            }
        }).addTo(map);
    }

    function renderRegionList(regions) {
        const container = document.getElementById('listContainer');
        container.innerHTML = '';

        regions.forEach(region => {
            const div = document.createElement('div');
            div.className = 'region-item';
            div.id = 'item-' + region.id;

            div.onclick = () => selectRegion(region.id);
            div.onmouseenter = () => highlightRegion(region.id);
            div.onmouseleave = () => resetHighlight(region.id);

            const formattedId = region.id.replace('.', ',');

            div.innerHTML = `
                <div class="region-id">ID: ${formattedId}</div>
                <div class="region-meta-line"><strong>DTH:</strong> ${region.dth}</div>
                <div class="region-meta-line"><strong>MI:</strong> ${region.mi}</div>
                <div class="region-meta-line"><strong>RKS:</strong> ${region.rks}</div>
                <div class="region-meta-line"><strong>DS:</strong> ${region.ds}</div>
            `;
            container.appendChild(div);
        });
    }

    function toggleColors() {
        colorEnabled = !colorEnabled;
        const btn = document.getElementById('colorToggle');
        btn.classList.toggle('active');
        document.getElementById('colorText').textContent = colorEnabled ? 'Włączone' : 'Wyłączone';
        renderMap();
    }

    function changeMap(type, btn) {
        map.removeLayer(tileLayer);
        tileLayer = tileProviders[type].addTo(map);
        updateAttribution(type);
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function selectRegion(regionId) {
        document.querySelectorAll('.region-item').forEach(el => el.classList.remove('active'));
        const activeEl = document.getElementById('item-' + regionId);
        if (activeEl) {
            activeEl.classList.add('active');
            activeEl.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }

        if (featureMap[regionId] && featureMap[regionId].length > 0) {
            const group = new L.FeatureGroup(featureMap[regionId]);
            const bounds = group.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds, {
                    padding: [40, 40],
                    maxZoom: 10
                });
            }
        }
    }

    function highlightRegion(regionId) {
        if (!geoJsonLayer || !featureMap[regionId]) return;

        featureMap[regionId].forEach(layer => {
            layer.setStyle({
                weight: 3,
                color: '#111827',
                fillOpacity: colorEnabled ? 0.6 : 0.3
            });
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
        });
    }

    function resetHighlight(regionId) {
        if (!geoJsonLayer || !featureMap[regionId]) return;
        featureMap[regionId].forEach(layer => {
            geoJsonLayer.resetStyle(layer);
        });
    }

    function searchCity(q) {
        if (!q || q.trim().length < 2) return;

        fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=pl&limit=1`,
            {
                headers: {
                    'Accept-Language': 'pl',
                    'User-Agent': 'Mapa-DTH/1.0'
                }
            }
        )
        .then(r => r.json())
        .then(d => {
            if (!d.length) {
                alert('Nie znaleziono miasta');
                return;
            }
            
            const lat = parseFloat(d[0].lat);
            const lon = parseFloat(d[0].lon);

            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            currentMarker = L.marker([lat, lon], {
                icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25, 41],
                    shadowSize: [41, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                })
            }).addTo(map);

            currentMarker.bindPopup(`<b>${d[0].display_name}</b>`).openPopup();
            map.setView([lat, lon], 10);
        })
        .catch(err => console.error('Błąd wyszukiwania:', err));
    }

    function filterRegionList(term) {
        const t = (term || '').trim().toLowerCase();
        if (!t) {
            renderRegionList(allRegions);
            return;
        }

        const filtered = allRegions.filter(r =>
            (r.id || '').toLowerCase().includes(t) ||
            (r.dth || '').toLowerCase().includes(t) ||
            (r.mi || '').toLowerCase().includes(t) ||
            (r.rks || '').toLowerCase().includes(t) ||
            (r.ds || '').toLowerCase().includes(t)
        );

        renderRegionList(filtered);
    }
</script>

</body>
</html>
